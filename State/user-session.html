<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../bower_components/item-rendering-engine/elements/app-config/app-config.html">

<link rel="import" href="../bower_components/item-rendering-engine/behaviors/MultiInstance.html">

<script type="text/javascript">
    (function() {
        'use strict';

        /**
         * Api service object
         * @type {Object}
         */
        var Config = document.createElement('app-config');

        /**
         * user session data
         * @type {Object}
         */
        var Session = {
            /**
             * holds the authorization info of the current user
             * @type {Object}
             */
            userAuth: null,
            /**
             * information about the user
             * @type {Object?}
             */
            user: null,

            /**
             * list of available test sessions
             * @type {Object}
             */
            testSessions: null,

            /**
             * current selected session
             * @type {Object}
             */
            currentTestSession: null,

            /**
             * Settings object per the person
             * @type {[type]}
             */
            settings: null,

            /**
             * Current Test State
             * @type {Object}
             */
            testState: null,

            /**
             * Current's User accommodations
             * @type {Object}
             */
            accommodations: null,

            isPractice:false,
            /**
             * Metadata about the users selected form
             * @type {Boolean}
             */
            formMetadata: null,

            /**
             * The highlights within passages, should have the structure of:
             * {
             *    {passageKey}:[serializedHighlights]
             * }
             * @type {Array}
             */
            passageHighlights: {
                type: Object,
                value: null
            }
        };

        var Api = {
            /**
             * contains information about the access token
             * @type {Object}
             */
            _token: null,

            /**
             * endpoint used for user info api
             * @type {String}
             */
            _userInfoApi: null,

            /**
             * endpoint used for admin api
             * @type {String}
             */
            _adminApi: null,

            /**
             * endpoint used for data transfers
             * @type {String}
             */
            _apiData: 'http://localhost:5000/api/v1/',

            _authConfig: {
                client_id: 'qai_students',
                client_secret: '7AB5A701-E7A5-4E36-A7B1-800F1CC7BFE7',
                grant_type: 'password',
                scope: 'openid userInfo'
            },

            /**
             * sends an ajax request
             * @param  {Object} options
             * @return {Promise}
             */
            ajaxRequest: function(ajaxOptions) {
                var ironRequest = document.createElement('iron-request');
                var options = {
                    method: 'POST',
                    handleAs: 'json'
                };

                options = Object.merge(options, ajaxOptions);

                return ironRequest.send(options);
            },

            /**
             * Authenticates a user and sets the access_token
             * @param  {string} username [description]
             * @param  {string} password [description]
             * @return {Promise}
             */
            connect: function(username, password) {
                //set config variables
                this._apiToken =  Config.get('adminApi') + '/' + "connect/token";
                this._userInfoApi = Config.get('adminApi') + '/' + 'connect/userInfo';
                this._adminApi = Config.get('adminApi');

                var data = new FormData();
                data.append('client_id', this._authConfig.client_id);
                data.append('client_secret', this._authConfig.client_secret);
                data.append('grant_type', this._authConfig.grant_type);
                data.append('scope', this._authConfig.scope);
                data.append('username', username);
                data.append('password', password);

                var promise = new Promise(function(resolve, reject) {
                    this.ajaxRequest({
                        url: this._apiToken,
                        body: data
                    }).then(function(xhr) {
                        this._token = xhr.response;

                        return this.ajaxRequest({
                            url: this._userInfoApi,
                            method: 'GET',
                            headers: {
                                'Authorization': this._token.token_type + ' ' +
                                this._token.access_token
                            }
                        });
                    }.bind(this)).then(function(xhr) {
                        var userInfo = xhr.response;
                        resolve({
                            token: this._token,
                            userInfo: userInfo
                        });
                    }.bind(this)).catch(function(error) {
                        reject(error);
                    });
                }.bind(this));

                return promise;
            },

            /**
             * send a request to the api
             * @param  {String} method
             * @param  {Object} options
             * @return {Promise}
             */
            send: function(method, options) {
                var url = this._adminApi + '/' + method;

                options = options || {};

                options.url = url;
                options.method = options.method || 'GET';

                var authHeader = {
                    'Authorization': this._token.token_type + ' ' +
                    this._token.access_token
                };
                options.headers = Object.merge(options.headers, authHeader);

                return this.ajaxRequest(options);
            }
        };

        Polymer({

            is: "user-session",
            hostAttributes: {
                hidden: true
            },
            properties:{
            },

            behaviors: [
                App.Behaviors.MultiInstance
            ],

            /**
             * get data from session
             * @param  {String} key
             * @return {Object}
             */
            get: function(key) {
                return Session[key];
            },

            /**
             * set data in session
             * @param  {String} key
             * @param  {Object} value
             */
            set: function(key, value) {
                return (Session[key] = value);
            },

            checkAccess: function (action, params) {
                action = Config.render(action, params);

                var options = {
                    method: 'POST',
                    body: params,
                    headers: {
                        "Accept": "text/html; charset=UTF-8",
                        "Content-Type": "application/json"
                    },
                };
                return Api.send(action, options);
            },

            isPractice:function(){
                return this.get('isPractice');
            },

            /**
             * Authenticates and loads all data needed by the user
             * @param  {String} username
             * @param  {String} password
             */
            createSession: function(username, password) {
                Api.connect(username, password).then(function(userAuth) {
                    Session.userAuth = userAuth;
                    this.fireOnAll('session-created', userAuth);
                    return this._loadSessionData();
                }.bind(this)).catch(function(e) {
					console.warn(e);
                    this.fireOnAll(
                        'session-error',
                        new Error('sessionError')
                    );
                }.bind(this));
            },

            completeSession: function () {
                Session.currentTestSession = null;
                Session.testState  = null;
                Session.heartBeat = null;
                Session.passageHighlights = {};

                this.fireOnAll('session-completed');
            },

            /**
             * destroy the current session and fire a session-destroy event
             */
            destroySession: function() {
                Session = {
                    userInfo: null,
                    user: null,
                    testSessions: null,
                    currentTestSession: null,
                    testState: null,
                    settings: null,
                    heartBeat: null,
                    accommodations: null,
                    formMetadata: null,
                    passageHighlights: {}
                };

                this.fireOnAll('session-destroyed');
                this.fire('iron-signal', {
                    name: 'session-destroyed',
                    data: null
                });
            },

            destroyPackage: function () {
                this.fireOnAll('package-destroyed');
            },

            loadTestSession: function() {
                if(Session.currentTestSession !== null) {
                    Api.send(Config.render('testForm', {
                        formName: Session.currentTestSession.formName
                    })).then(function(xhr) {
                        Session.formMetadata = xhr.response.metadata;
                        this.fireOnAll('session-selected', xhr.response);
                    }.bind(this));
                } else {
                    throw new Error('No test session selected');
                }
            },

            /**
             * Send heart beat data to the server
             * @param  {String} postData Heart Beat object
             * @return {Object}          Promise object for further handling
             */
            postHeartBeat: function (postData) {
                var options = {
                    method: 'POST',
                    body: postData,
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    timeout: 5000
                };

                return Api.send(Config.render('heartBeat', {
                    sessionId: Session.userAuth.testSessionKey
                }), options);
            },

            /**
             * Send the save state to the server
             * @param  {String} postData
             * @return {Promise}
             */
            postTestState: function(postData) {
                return Api.send(Config.render('testState', {
                    sessionId: Session.userAuth.testSessionKey
                }), {
                    method: 'POST',
                    body: postData,
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    timeout: 5000
                });
            },

            postAudioResponse : function (postData) {
                return new Promise(function (resolve, reject) {
                    Api.send(Config.render('assets'), {
                        method: 'POST',
                        body: postData,
                        handleAs: 'json'
                    })
                    .catch(reject)
                    .then(function (xhr) {
                        resolve(xhr.response.toString());
                    }.bind(this));
                });
            },

            getAudioResponse: function (name) {
                return Api.send(Config.render('getAssets', {
                    name: name
                }),
                {
                    method: 'GET',
                    handleAs: 'blob'
                });
            },

            /**
             * retrieves the test state from the server
             * @return {Promise}
             */
            getTestState: function() {
                return Api.send(Config.render('testState', {
                    sessionId: Session.currentTestSession.testUserFormPartId
                }),
                {
                    headers: {
                        "Accept": "application/json"
                    },
                });
            },

            /**
             * sends a request to the api so the backend can create a
             * test user session that we can use for save state and heartbeat
             * @return {Promise}
             */
            startTest: function() {
                var promise = new Promise(function(resolve, reject) {
                    Api.send(Config.render('testStart', {
                        sessionSub: Session.currentTestSession.testUserFormPartId
                    }), {
                        method: 'POST'
                    }).then(function(xhr) {
                        var result = xhr.response.toString();
                        Session.userAuth.testSessionKey = result;                        
                        this.fireOnAll('test-started', Session.userAuth.testSessionKey);
                        resolve(result);
                    }.bind(this)).catch(reject);
                }.bind(this));

                return promise;
            },

            saveTest: function(pause) {
                var deferred = {};

                var promise = new Promise(function(resolve, reject) {
                    deferred = {
                        resolve: resolve,
                        reject: reject
                    };
                });

                this.fire('iron-signal', {
                    name: 'submit-test',
                    data: {
                        deferred: deferred,
                        pause: !!pause
                    }
                });

                return promise;
            },

            /**
             * fetch all the literals
             * @method getLiterals
             */
            getLiterals: function() {
                return document.createElement('iron-request').
                    send({
                        url: Config.render('literals', {
                            literalsFile: 'literals.json'
                        })
                    });
            },

            loadSettingsForPracticeTests: function () {
                var options = {
                    url: Config.get('adminApi') + '/' + Config.get('adminSettings'),
                    method: 'GET'
                };
                return Api.ajaxRequest(options).then(function (xhr) {
                    Session.settings = xhr.response;
                });
            },

            /**
             * Loads all data needed by the user and fires a load event
             * @return {Promise}
             */
            _loadSessionData: function() {
                return this._loadUserData().then(function(xhr) {
                    Session.user = xhr.response;
                    this.fireOnAll('session-user', Session.user);
                    return this._loadTestSessions();
                }.bind(this)).then(function(xhr) {
                    if (!xhr.response) {
                        throw new Error("No Sessions for this user");
                    }
                    Session.testSessions = xhr.response;
                    Session.testSessions.forEach(function(session){
                        session.formName = session.partWebResource.replace('.html', '')
                    })

                    this.fireOnAll('session-load', Session);
                    return this._loadSettings();
                }.bind(this)).then(function(xhr) {
					if (!xhr.response) {
					console.warn("No Settings for this user");
					}
                    Session.settings = xhr.response;

                    this.fireOnAll('user-session-ready', Session);
                    return this._loadAccommodations();
                }.bind(this)).then(function (xhr) {
					if (!xhr.response) {
						console.warn("No accommodations for this user");
					}
                    Session.accommodations = xhr.response;
                    // is there a reason we're using fireOnAll with this multiinstance thing instead of iron-signals?
                    // also, it appears this event is never listened for anyway
                    this.fireOnAll('user-accommodations-ready', Session);

                    // fire an event that we use to tell directions modal whether to use tts, for now
                    this.fire('iron-signal', {
                        name: 'user-accommodations-ready',
                        data: Session.accommodations
                    });
                }.bind(this));
            },

            /**
             * loads test sessions assosiated with the current user
             * @return {Promise}
             */
            _loadTestSessions: function() {
                return Api.send(Config.render('testSessions', {
                    userSub: Session.userAuth.userInfo.sub
                }));
            },

            /**
             * fetch user data form the api endpoint
             * @return {Promise}
             */
            _loadUserData: function() {
                return Api.send(Config.render('testUser', {
                    userSub: Session.userAuth.userInfo.sub
                }));
            },

            /**
             * fetch tds setting from the api endpoint
             * @return {Promise}
             */
            _loadSettings: function () {
                return Api.send(Config.get('adminSettings'));
            },

            _loadAccommodations: function () {
                return Api.send(Config.render('accommodations', {
                    userSub: Session.userAuth.userInfo.sub
                }));
            }
        });
    }());
</script>
